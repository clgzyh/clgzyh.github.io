---
layout    : post
title     : "Hadoop-3.4.2é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²"
date      : 2025-11-19
lastupdate: 2025-11-19
categories: Hadoop
render_with_liquid: false
cheatsheet: false
---

# Hadoop-3.4.2é«˜å¯ç”¨é›†ç¾¤éƒ¨ç½²

æœ¬å®éªŒåŸºäºå‰æ–‡**Hadoop-3.4.2é›†ç¾¤åŒ–éƒ¨ç½²**ä½œä¸ºåŸºç¡€ç¯å¢ƒ

å°†å½“å‰çš„ **Hadoop 3.4.2 ä¸‰èŠ‚ç‚¹æ ‡å‡†é›†ç¾¤ï¼ˆ1 NameNode + 2 DataNodeï¼‰** å‡çº§ä¸º **é«˜å¯ç”¨ï¼ˆHA, High Availabilityï¼‰é›†ç¾¤**ï¼Œæ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**é¿å…å•ç‚¹æ•…éšœï¼ˆSPOFï¼‰**ï¼Œå³å½“ä¸» NameNode å®•æœºæ—¶ï¼Œå¤‡ç”¨ NameNode èƒ½è‡ªåŠ¨æ¥ç®¡æœåŠ¡ã€‚



æ¶æ„å¯¹æ¯”

| ç»„ä»¶            | åŸå§‹æ¶æ„       | HA æ¶æ„                                              |
| --------------- | -------------- | ---------------------------------------------------- |
| NameNode        | 1 ä¸ªï¼ˆmasterï¼‰ | **2 ä¸ª**ï¼šactive + standbyï¼ˆä¾‹å¦‚ master + slave1ï¼‰   |
| å…±äº«å­˜å‚¨        | æ—              | **QJMï¼ˆQuorum Journal Managerï¼‰** æˆ– NFSï¼ˆæ¨è QJMï¼‰ |
| æ•…éšœåˆ‡æ¢        | æ‰‹åŠ¨           | **è‡ªåŠ¨**ï¼ˆé€šè¿‡ ZooKeeper + ZKFCï¼‰                    |
| ResourceManager | 1 ä¸ª           | å¯é€‰ HAï¼ˆæœ¬æŒ‡å—å…ˆèšç„¦ HDFS HAï¼‰                      |



## ä¸€ã€æ–°å¢ç»„ä»¶ä¸è§’è‰²è§„åˆ’ï¼ˆä»ç”¨ 3 èŠ‚ç‚¹ï¼‰

| ä¸»æœºå            | IP        | è§’è‰²                                                         |
| ----------------- | --------- | ------------------------------------------------------------ |
| hadoop01 (master) | 10.0.0.10 | **NameNode (active)**, ZKFC, JournalNode, DataNodeï¼ˆå¯é€‰ï¼‰, ResourceManager |
| hadoop02 (slave1) | 10.0.0.20 | **NameNode (standby)**, ZKFC, JournalNode, DataNode, NodeManager |
| hadoop03 (slave2) | 10.0.0.30 | JournalNode, DataNode, NodeManager, **ZooKeeper**            |

> ğŸ’¡ è¯´æ˜ï¼š
>
> - **JournalNode**ï¼šè‡³å°‘ 3 ä¸ªï¼ˆå¥‡æ•°ï¼‰ï¼Œç”¨äºåŒæ­¥ edits æ—¥å¿—
> - **ZooKeeper**ï¼šè‡³å°‘ 3 èŠ‚ç‚¹ï¼ˆå¯å¤ç”¨ç°æœ‰æœºå™¨ï¼‰
> - **ZKFCï¼ˆZooKeeper Failover Controllerï¼‰**ï¼šè¿è¡Œåœ¨æ¯ä¸ª NameNode ä¸Šï¼Œç›‘æ§ NN çŠ¶æ€å¹¶è§¦å‘åˆ‡æ¢

## äºŒã€éƒ¨ç½²æ­¥éª¤æ¦‚è§ˆ

1. **å®‰è£… ZooKeeperï¼ˆ3 èŠ‚ç‚¹ï¼‰**
2. **é…ç½® JournalNode**
3. **ä¿®æ”¹ HDFS é…ç½®å¯ç”¨ HA**
4. **åˆå§‹åŒ– JournalNode å’Œ NameNode HA çŠ¶æ€**
5. **å¯åŠ¨ HA é›†ç¾¤**
6. **éªŒè¯æ•…éšœåˆ‡æ¢**



### æ­¥éª¤ 1ï¼šéƒ¨ç½² ZooKeeperï¼ˆåœ¨æ‰€æœ‰ 3 èŠ‚ç‚¹ï¼‰

#### 1.1 ä¸‹è½½å¹¶è§£å‹ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰

```bash
# ä»¥ hadoop ç”¨æˆ·æ“ä½œ
cd ~
wget https://archive.apache.org/dist/zookeeper/zookeeper-3.8.4/apache-zookeeper-3.8.4-bin.tar.gz
tar -zxvf apache-zookeeper-3.8.4-bin.tar.gz
mv apache-zookeeper-3.8.4-bin zookeeper
```

#### 1.2 é…ç½® `zoo.cfg`ï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰

```bash
mkdir -p ~/zookeeper/data
echo "1" > ~/zookeeper/data/myid   # master ä¸Šä¸º 1
# slave1 ä¸Šæ‰§è¡Œï¼šecho "2" > ~/zookeeper/data/myid
# slave2 ä¸Šæ‰§è¡Œï¼šecho "3" > ~/zookeeper/data/myid
```

ç¼–è¾‘ `~/zookeeper/conf/zoo.cfg`ï¼š

```bash
tickTime=2000
dataDir=/home/hadoop/zookeeper/data
clientPort=2181
initLimit=5
syncLimit=2
server.1=master:2888:3888
server.2=slave1:2888:3888
server.3=slave2:2888:3888
```

#### 1.3 å¯åŠ¨ ZooKeeperï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰

```bash
~/zookeeper/bin/zkServer.sh start
# æ£€æŸ¥çŠ¶æ€
~/zookeeper/bin/zkServer.sh status
```

> åº”çœ‹åˆ°ä¸€ä¸ª leaderï¼Œä¸¤ä¸ª follower



### æ­¥éª¤ 2ï¼šé…ç½® Hadoop HAï¼ˆåœ¨ master ä¸Šä¿®æ”¹ï¼‰

#### 2.1 ä¿®æ”¹ `hdfs-site.xml`

```bash
vim hdfs-site.xml
```

```xml
<configuration>
    <!-- å¯ç”¨ HA -->
    <property>
        <name>dfs.nameservices</name>
        <value>mycluster</value>
    </property>

    <!-- å®šä¹‰ä¸¤ä¸ª NameNode çš„ ID -->
    <property>
        <name>dfs.ha.namenodes.mycluster</name>
        <value>nn1,nn2</value>
    </property>

    <!-- nn1 (master) çš„ RPC åœ°å€ -->
    <property>
        <name>dfs.namenode.rpc-address.mycluster.nn1</name>
        <value>master:9000</value>
    </property>

    <!-- nn2 (slave1) çš„ RPC åœ°å€ -->
    <property>
        <name>dfs.namenode.rpc-address.mycluster.nn2</name>
        <value>slave1:9000</value>
    </property>

    <!-- nn1 çš„ HTTP åœ°å€ -->
    <property>
        <name>dfs.namenode.http-address.mycluster.nn1</name>
        <value>master:9870</value>
    </property>

    <!-- nn2 çš„ HTTP åœ°å€ -->
    <property>
        <name>dfs.namenode.http-address.mycluster.nn2</name>
        <value>slave1:9870</value>
    </property>

    <!-- JournalNode åœ°å€ï¼ˆ3 èŠ‚ç‚¹ï¼‰ -->
    <property>
        <name>dfs.namenode.shared.edits.dir</name>
        <value>qjournal://master:8485;slave1:8485;slave2:8485/mycluster</value>
    </property>

    <!-- å®¢æˆ·ç«¯æ•…éšœè½¬ç§»ä»£ç† -->
    <property>
        <name>dfs.client.failover.proxy.provider.mycluster</name>
        <value>org.apache.hadoop.hdfs.server.namenode.ha.ConfiguredFailoverProxyProvider</value>
    </property>

    <!-- å¯ç”¨è‡ªåŠ¨æ•…éšœè½¬ç§» -->
    <property>
        <name>dfs.ha.automatic-failover.enabled</name>
        <value>true</value>
    </property>

    <!-- JournalNode æœ¬åœ°ç›®å½• -->
    <property>
        <name>dfs.journalnode.edits.dir</name>
        <value>/home/hadoop/hadoop/journalnode</value>
    </property>

    <!-- å…¶ä»–åŸæœ‰é…ç½®ä¿ç•™ -->
    <property>
        <name>dfs.replication</name>
        <value>2</value>
    </property>
    <property>
        <name>dfs.namenode.name.dir</name>
        <value>/home/hadoop/hadoop/hdfs/namenode</value>
    </property>
    <property>
        <name>dfs.datanode.data.dir</name>
        <value>/home/hadoop/hadoop/hdfs/datanode</value>
    </property>
    
    <!-- é˜²æŠ¤æ–¹æ³•é…ç½® -->
    <property>
        <name>dfs.ha.fencing.methods</name>
        <value>sshfence</value>
    </property>
    <property>
        <name>dfs.ha.fencing.ssh.private-key-files</name>
        <value>/home/hadoop/.ssh/id_rsa</value>
    </property>
    <property>
        <name>dfs.ha.fencing.ssh.connect-timeout</name>
        <value>30000</value>
    </property>
</configuration>
```

#### 2.2 ä¿®æ”¹ `core-site.xml`

```bash
vim core-site.xml
```

```xml
<configuration>
    <!-- ä½¿ç”¨ nameservice åç§°ä»£æ›¿å…·ä½“ä¸»æœº -->
    <property>
        <name>fs.defaultFS</name>
        <value>hdfs://mycluster</value>
    </property>

    <!-- ZooKeeper åœ°å€ -->
    <property>
        <name>ha.zookeeper.quorum</name>
        <value>master:2181,slave1:2181,slave2:2181</value>
    </property>

    <property>
        <name>hadoop.tmp.dir</name>
        <value>/home/hadoop/hadoop/tmp</value>
    </property>
</configuration>
```

#### 3 åˆ†å‘é…ç½®åˆ°æ‰€æœ‰èŠ‚ç‚¹

```bash
for node in master slave1 slave2; do
  scp ~/hadoop/etc/hadoop/{core-site.xml,hdfs-site.xml} hadoop@$node:~/hadoop/etc/hadoop/
done
```



## æ­¥éª¤ 3ï¼šåˆå§‹åŒ– HA çŠ¶æ€

### 3.1 å¯åŠ¨ JournalNodeï¼ˆæ‰€æœ‰èŠ‚ç‚¹ï¼‰

```bash
hdfs --daemon start journalnode
```

### 3.2 æ ¼å¼åŒ–ç¬¬ä¸€ä¸ª NameNodeï¼ˆä»…åœ¨ masterï¼‰

```bash
# å¦‚æœå·²æœ‰æ•°æ®ï¼Œå…ˆå¤‡ä»½ï¼å¦åˆ™ä¼šä¸¢å¤±
hdfs namenode -format
```

### 3.3 å¯åŠ¨ masterçš„ NameNode

```bash
hdfs --daemon start namenode
```

### 3.4 åœ¨ slave1ä¸ŠåŒæ­¥å…ƒæ•°æ®

```bash
hdfs namenode -bootstrapStandby
```

### 3.5 åˆå§‹åŒ– HA çŠ¶æ€åˆ° ZooKeeperï¼ˆä»»æ„**NameNode** èŠ‚ç‚¹ï¼Œå³masterå’Œslave1å…¶ä¸€ï¼‰

```bash
hdfs zkfc -formatZK
```



## æ­¥éª¤ 4ï¼šå¯åŠ¨æ•´ä¸ª HA é›†ç¾¤

### åœ¨ master:

```bash
start-dfs.sh    # ä¼šå¯åŠ¨ NNã€DNã€JNã€ZKFC
start-yarn.sh   # RM åœ¨ hadoop01ï¼ˆæš‚ä¸é… YARN HAï¼‰
```

### åœ¨ slave1:

```bash
# å¦‚æœ start-dfs.sh æ²¡è‡ªåŠ¨å¯åŠ¨ standby NNï¼Œæ‰‹åŠ¨å¯ï¼ˆé€šå¸¸ä¸éœ€è¦ï¼‰
hdfs --daemon start namenode
```



##  æ­¥éª¤ 5ï¼šéªŒè¯ HA

### 5.1 æŸ¥çœ‹ NameNode çŠ¶æ€

```bash
hdfs haadmin -getServiceState nn1  # åº”è¿”å› active
hdfs haadmin -getServiceState nn2  # åº”è¿”å› standby
```

### 5.2 Web UI

- http://master:9870 â†’ æ˜¾ç¤º **Active**
- http://slave1:9870 â†’ æ˜¾ç¤º **Standby**

### 5.3 æ¨¡æ‹Ÿæ•…éšœåˆ‡æ¢

```bash
# åœ¨ hadoop01 ä¸Šæ€æ­» NameNode
pkill -f NameNode

# ç­‰å¾…å‡ ç§’åæ£€æŸ¥
hdfs haadmin -getServiceState nn2  # åº”å˜ä¸º active
```

æ¢å¤åï¼ŒåŸ active ä¸ä¼šè‡ªåŠ¨æŠ¢å›ï¼ˆé¿å…è„‘è£‚ï¼‰ï¼Œéœ€æ‰‹åŠ¨æˆ–é…ç½®è‡ªåŠ¨æ¢å¤ç­–ç•¥ã€‚



## ä¸‰ã€å¯åŠ¨é›†ç¾¤

åˆæ¬¡å¯åŠ¨æ—¶ï¼Œå¯æ ¹æ®ä¸Šé¢çš„å†…å®¹ã€‚å½“æœºå™¨å…³æœºä¹‹åï¼Œå¦‚ä½•å¿«é€Ÿå¯åŠ¨ï¼Ÿ



åˆ‡æ¢åˆ°hadoopç”¨æˆ·ï¼ˆæ‰€æœ‰æœºå™¨éƒ½éœ€è¦ï¼‰

```bash
su - hadoop
```

å¯åŠ¨Zookeeperï¼ˆæ‰€æœ‰æœºå™¨éƒ½éœ€è¦ï¼‰

```bash
./zookeeper/bin/zkServer.sh start
```

æŸ¥çœ‹Zookeeperé›†ç¾¤çŠ¶æ€

```bash
./zookeeper/bin/zkServer.sh status
```

ä½¿ç”¨jpsæŸ¥çœ‹

```bash
jps
```

```bash
1403 Jps
1308 QuorumPeerMain
```



å¯åŠ¨hdfsï¼ˆä»…åœ¨Masteræœºå™¨æ‰§è¡Œï¼‰

```bash
start-dfs.sh
```

```bash
Starting namenodes on [master slave1]
Starting datanodes
Starting journal nodes [slave2 slave1 master]
Starting ZK Failover Controllers on NN hosts [master slave1]
```

éªŒè¯hdfsï¼Œä½¿ç”¨jpså‘½ä»¤

```bash
jps
```

masterèŠ‚ç‚¹

```bash
1795 JournalNode
2085 Jps
2005 DFSZKFailoverController
1308 QuorumPeerMain
1566 NameNode
```

slave1èŠ‚ç‚¹

```bash
1808 DFSZKFailoverController
1861 Jps
1273 QuorumPeerMain
1451 NameNode
1663 JournalNode
```

slave2èŠ‚ç‚¹

```bash
1457 DataNode
1570 JournalNode
1270 QuorumPeerMain
1647 Jps
```



å¯åŠ¨yarnï¼ˆä»…åœ¨Masteræœºå™¨æ‰§è¡Œï¼‰

```bash
start-yarn.sh
```

```bash
Starting resourcemanager
Starting nodemanagers
```

éªŒè¯yarnï¼Œä½¿ç”¨jpså‘½ä»¤

```bash
jps
```

masterèŠ‚ç‚¹

```bash
2512 Jps
1795 JournalNode
2005 DFSZKFailoverController
2188 ResourceManager
1308 QuorumPeerMain
1566 NameNode
```

slave1èŠ‚ç‚¹

```bash
1808 DFSZKFailoverController
1941 NodeManager
2105 Jps
1273 QuorumPeerMain
1451 NameNode
1663 JournalNode
```

slave2èŠ‚ç‚¹

```bash
1457 DataNode
1570 JournalNode
1718 NodeManager
1270 QuorumPeerMain
1847 Jps
```
